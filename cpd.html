<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2016-01-23 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Winston &#x2013; CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20160123" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Winston
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2016-01-23</span>
                  &nbsp;| <span id="projectVersion">Version: 1.3.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="Winston">Winston</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                          <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                                                          <li class="expanded">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                    <ul>
                      <li class="none">
            <strong>CPD</strong>
          </li>
                      <li class="none">
                          <a href="pmd.html" title="PMD">PMD</a>
            </li>
                      <li class="none">
                          <a href="findbugs.html" title="FindBugs">FindBugs</a>
            </li>
                      <li class="none">
                          <a href="xref/index.html" title="Source Xref">Source Xref</a>
            </li>
                      <li class="none">
                          <a href="apidocs/index.html" title="JavaDocs">JavaDocs</a>
            </li>
                      <li class="none">
                          <a href="cobertura/index.html" title="Cobertura Test Coverage">Cobertura Test Coverage</a>
            </li>
                      <li class="none">
                          <a href="javancss.html" title="JavaNCSS Report">JavaNCSS Report</a>
            </li>
              </ul>
        </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2><a name="CPD_Results"></a>CPD Results</h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 5.3.2.</p></div>
<div class="section">
<h2><a name="Duplications"></a>Duplications</h2>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/WWSCommandString.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/WWSCommandString.html#L26">26</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/wws/WwsCommandString.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/wws/WwsCommandString.html#L47">47</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>  }

  public String[] getCommandSplits() {
    return commandSplits;
  }

  public String getString(final int i) {
    if (i &gt;= commandSplits.length)
      return null;
    else
      return commandSplits[i];
  }

  public int getInt(final int i) {
    int result = Integer.MIN_VALUE;
    try {
      result = Integer.parseInt(commandSplits[i]);
    } catch (final Exception e) {
    }
    return result;
  }

  public double getDouble(final int i) {
    double result = Double.NaN;
    try {
      result = Double.parseDouble(commandSplits[i]);
    } catch (final Exception e) {
    }
    return result;
  }

  public String getID() {
    if (commandSplits.length &lt; 2)
      return null;
    else
      return commandSplits[1];
  }

  public String getWinstonSCNL() {
    if (commandSplits.length &lt; 6)
      return null;
    else {
      String loc = &quot;&quot;;
      if (!commandSplits[5].equals(&quot;--&quot;))
        loc = &quot;$&quot; + commandSplits[5];
      return commandSplits[2] + &quot;$&quot; + commandSplits[3] + &quot;$&quot; + commandSplits[4] + loc;
    }
  }

  public double getT1(final boolean isScnl) {
    int ofs = 0;
    if (isScnl)
      ofs = 1;
    if (commandSplits.length &lt; 6 + ofs)
      return Double.NaN;
    else
      return getDouble(5 + ofs);
  }

  public double getT2(final boolean isScnl) {
    int ofs = 0;
    if (isScnl)
      ofs = 1;
    if (commandSplits.length &lt; 7 + ofs)
      return Double.NaN;
    else
      return getDouble(6 + ofs);
  }

  public int length() {
    return commandSplits.length;
  }

  public boolean isLegal(final int cnt) {
    return commandSplits.length == cnt;
  }

  public boolean isLegalSCNTT(final int cnt) {
    if (commandSplits.length != cnt)
      return false;

    if (Double.isNaN(getT1(false)) || Double.isNaN(getT2(false)))
      return false;

    return true;
  }

  public boolean isLegalSCNLTT(final int cnt) {
    if (commandSplits.length != cnt)
      return false;

    if (Double.isNaN(getT1(true)) || Double.isNaN(getT2(true)))
      return false;

    return true;
  }

  public String getS() {
    if (commandSplits.length &lt;= 2)
      return null;

    return commandSplits[2];
  }

  public String getC() {
    if (commandSplits.length &lt;= 3)
      return null;

    return commandSplits[3];
  }

  public String getN() {
    if (commandSplits.length &lt;= 4)
      return null;

    return commandSplits[4];
  }

  public String getL() {
    if (commandSplits.length &lt;= 5)
      return null;

    return commandSplits[5];
  }

  // TODO: fix getL() below.
  public String getEarthwormErrorString(final int sid, final String msg) {
    return getID() + &quot; &quot; + sid + &quot; &quot; + getS() + &quot; &quot; + getC() + &quot; &quot; + getN() + &quot; &quot; + getL() + &quot; &quot;
        + msg + &quot;\n&quot;;
  }
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L348">348</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L466">466</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>          if (!filled) {
            d = new double[] {i, Integer.MAX_VALUE, Integer.MIN_VALUE, 0, 0};
            winston.getStatement().execute(&quot;INSERT IGNORE INTO `&quot; + table + &quot;` VALUES (&quot; + i + &quot;,&quot;
                + Integer.MAX_VALUE + &quot;,&quot; + Integer.MIN_VALUE + &quot;,0,0)&quot;);
          }
        }
        heliList[j++] = d;
      }
      double st = tb.getStartTimeJ2K();
      final double dt = 1 / tb.samplingRate();
      for (int i = 0; i &lt; tb.numSamples(); i++) {
        j = (int) (Math.floor(st) - fst);
        final double[] d = heliList[j];
        final int sample = tb.samples()[i];
        d[1] = Math.min(d[1], sample);
        d[2] = Math.max(d[2], sample);
        d[4] = (d[4] * d[3] + Math.abs(sample)) / (d[3] + 1);
        d[3] = d[3] + 1;
        st += dt;
      }

      for (int i = 0; i &lt; heliList.length; i++) {
        final int j2k = (int) Math.round(fst + i);
        winston.getStatement()
            .execute(&quot;UPDATE `&quot; + table + &quot;` SET smin=&quot; + (int) heliList[i][1] + &quot;, smax=&quot;
                + (int) heliList[i][2] + &quot;, rcnt=&quot; + (int) heliList[i][3] + &quot;, rsam=&quot;
                + heliList[i][4] + &quot; WHERE j2ksec=&quot; + j2k);
        opt.putData(j2k, heliList[i]);
      }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpMenuCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpMenuCommand.html#L70">70</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/MenuCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/MenuCommand.html#L141">141</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    final List&lt;String&gt; list = emulator.getWaveServerMenu(true, 0, 0, maxDays);
    final String[][] menu = new String[list.size()][8];
    int i = 0;
    for (final String s : list)
      menu[i++] = s.split(&quot;\\s&quot;);

    Arrays.sort(menu, getMenuComparator(sortCol, order));

    // display menu items
    for (final String[] line : menu) {
      if (line.length &lt; 8) {
        output.append(&quot;can't parse line, skipping. &quot; + Arrays.toString(line));
        continue;
      }

      SimpleDateFormat dateF = new SimpleDateFormat(Time.STANDARD_TIME_FORMAT);
      dateF.setTimeZone(timeZone);
      
      final double start = Double.parseDouble(line[6]);
      final double end = Double.parseDouble(line[7]);

      output.append(&quot;&lt;tr&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[1] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[2] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[3] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[4] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[5] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + dateF.format(Ew.asEpoch(start)) + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + dateF.format(Ew.asEpoch(end)) + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;td&gt;&quot; + line[8] + &quot;&lt;/td&gt;&quot;);
      output.append(&quot;&lt;/tr&gt;\n&quot;);
    }

    output.append(&quot;&lt;/table&gt;&quot;);</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/tools/pannel/AdminPanel.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/tools/pannel/AdminPanel.html#L36">36</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/tools/pannel/WinstonUpgradePanel.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/tools/pannel/WinstonUpgradePanel.html#L37">37</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        &quot;Winston Admin&quot;));
    setLayout(new BoxLayout(this, BoxLayout.PAGE_AXIS));

    final FormLayout layout = new FormLayout(&quot;left:p, 4dlu, fill:p:G&quot;, &quot;&quot;);

    final DefaultFormBuilder builder = new DefaultFormBuilder(layout);
    builder.setDefaultDialogBorder();

    createFields();
    builder.append(&quot;Current schema&quot;, currentVersion);
    builder.nextLine();
    builder.append(&quot;Available upgrade&quot;, upgradeDescription);
    builder.nextLine();
    builder.appendUnrelatedComponentsGapRow();
    builder.nextLine();
    builder.append(&quot;&quot;, upgradeB);
    add(builder.getPanel());
  }

  @Override
  protected void createFields() {
    ug = new Upgrade();

    currentVersion = new JTextField(ug.getCurrentVersion());

    upgradeDescription = new JTextArea(ug.getUpgraderDescription());
    upgradeDescription.setLineWrap(true);
    upgradeDescription.setWrapStyleWord(true);

    upgradeB = new JButton(&quot;upgrade&quot;);
    upgradeB.setEnabled(ug.upgradeAvailable());
    upgradeB.addActionListener(new ActionListener() {
      public void actionPerformed(final ActionEvent e) {
        start();
      }
    });
  }

  @Override
  protected void go() {
    ug.doUpgrade();
    removeAll();
    createUI();
  }

  @Override
  public boolean needsWinston() {
    return true;
  }
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpRsamCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpRsamCommand.html#L155">155</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/RsamCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/RsamCommand.html#L207">207</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    byte[] png;

    final Plot plot = new Plot();
    plot.setSize(width, height);
    plot.setBackgroundColor(new Color(0.97f, 0.97f, 0.97f));

    final MatrixRenderer mr = new MatrixRenderer(rsamData.getData(), false);
    final double max = Math.min(plotMax, rsamData.max(1) + rsamData.max(1) * .1);
    final double min = Math.max(plotMin, rsamData.min(1) - rsamData.max(1) * .1);

    mr.setExtents(startTime + timeZoneOffset, endTime + timeZoneOffset, min, max);
    mr.setLocation(70, 35, width - 140, height - 70);
    mr.createDefaultAxis();
    mr.setXAxisToTime(8, true, true);

    final String tzText =
        timeZone.getDisplayName(timeZone.inDaylightTime(J2kSec.asDate(endTime)), TimeZone.SHORT);
    final String bottomText =
        &quot;(&quot; + J2kSec.format(DISPLAY_DATE_FORMAT, startTime + timeZoneOffset) + &quot; to &quot;</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L315">315</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L440">440</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      opt.t1 = Math.min(opt.t1, tb.getStartTimeJ2K());
      opt.t2 = Math.max(opt.t2, tb.getEndTimeJ2K());

      if (!writeLocks) {
        setTimeSpan(code, opt.t1, opt.t2);
        // setTimeSpan(code, opt.t1, opt.t2);
      }

      /// ----- now insert/update helicorder/rsam data
      table = code + &quot;$$H&quot; + date;
      final double fst = Math.floor(tb.getStartTimeJ2K());
      final double cet = Math.ceil(tb.getEndTimeJ2K());
      final double[][] heliList = new double[((int) Math.round(cet - fst)) + 1][];
      int j = 0;
      for (int i = (int) Math.round(fst); i &lt;= (int) Math.round(cet); i++) {
        double[] d = opt.getData(i);
        if (d == null) {</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpMenuCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpMenuCommand.html#L104">104</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/MenuCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/MenuCommand.html#L178">178</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    writeSimpleHTML(output.toString());
  }

  private Comparator&lt;String[]&gt; getMenuComparator(final int sortCol, final char order) {
    return new Comparator&lt;String[]&gt;() {
      public int compare(final String[] e1, final String[] e2) {
        // numeric columns
        if (sortCol == 1 || sortCol == 6 || sortCol == 7) {
          final double d1 = Double.parseDouble(e1[sortCol]);
          final double d2 = Double.parseDouble(e2[sortCol]);

          // Do this the hard way to avoid an int overflow.
          // Yes, this bug was encountered in a running system.
          final double d = d1 - d2;
          if (d == 0)
            return 0;

          final int i = (d &lt; 0 ? -1 : 1);

          if (order == 'a')
            return i;
          else
            return -i;
        }
        // textual columns
        else {
          if (order == 'a')
            return e1[sortCol].compareTo(e2[sortCol]);
          else
            return e2[sortCol].compareTo(e1[sortCol]);
        }
      }
    };
  }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/server/http/cmd/GapsCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/GapsCommand.html#L196">196</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/StatusCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/StatusCommand.html#L125">125</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      Template template = cfg.getTemplate(&quot;gaps.ftl&quot;);
      Writer sw = new StringWriter();
      template.process(root, sw);
      String html = sw.toString();
      sw.close();

      FullHttpResponse response = new DefaultFullHttpResponse(request.getProtocolVersion(),
          HttpResponseStatus.OK, Unpooled.copiedBuffer(html, Charset.forName(&quot;UTF-8&quot;)));
      response.headers().set(HttpHeaders.Names.CONTENT_LENGTH, html.length());
      response.headers().set(HttpHeaders.Names.CONTENT_TYPE, &quot;text/html; charset=UTF-8&quot;);

      if (HttpHeaders.isKeepAlive(request)) {
        response.headers().set(HttpHeaders.Names.CONNECTION, HttpHeaders.Values.KEEP_ALIVE);
      }
      ctx.writeAndFlush(response);
    } catch (IOException e) {
      LOGGER.error(e.getLocalizedMessage());
    } catch (TemplateException e) {
      LOGGER.error(e.getLocalizedMessage());
    }
  }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetMetadataCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetMetadataCommand.html#L61">61</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/wws/cmd/GetMetadataCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/wws/cmd/GetMetadataCommand.html#L81">81</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    sb.append(String.format(&quot;%s %d\n&quot;, cmd.getID(), insts.size()));
    for (final Instrument inst : insts) {
      sb.append(&quot;name=&quot;);
      sb.append(escape(inst.getName()));
      sb.append(&quot;,&quot;);
      sb.append(&quot;description=&quot;);
      sb.append(escape(inst.getDescription()));
      sb.append(&quot;,&quot;);
      sb.append(&quot;longitude=&quot;);
      sb.append(inst.getLongitude());
      sb.append(&quot;,&quot;);
      sb.append(&quot;latitude=&quot;);
      sb.append(inst.getLatitude());
      sb.append(&quot;,&quot;);
      sb.append(&quot;height=&quot;);
      sb.append(inst.getHeight());
      sb.append(&quot;,&quot;);
      sb.append(&quot;timezone=&quot;);
      sb.append(inst.getTimeZone());
      sb.append(&quot;,&quot;);
      appendMap(sb, inst.getMetadata());
      sb.append(&quot;\n&quot;);
    }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/StatusCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/StatusCommand.html#L55">55</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/wws/cmd/StatusCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/wws/cmd/StatusCommand.html#L64">64</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    sb.append(String.format(&quot;Channel count: %d\n&quot;, sts.size()));
    lines++;

    final ArrayList&lt;Double&gt; ages = new ArrayList&lt;Double&gt;();
    for (final Channel st : sts)
      if (st.getMaxTime() &lt; now &amp;&amp; (ageThreshold == 0 || now - st.getMaxTime() &lt; ageThreshold))
        ages.add(now - st.getMaxTime());

    if (ages.size() == 0)
      ages.add(0d);

    Double[] d = new Double[ages.size() - 1];
    d = ages.toArray(d);
    Arrays.sort(d);

    sb.append(String.format(&quot;Median data age: %s\n&quot;, d[(d.length - 1) / 2]));
    lines++;</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/AbstractHttpCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/AbstractHttpCommand.html#L145">145</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/HttpBaseCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/HttpBaseCommand.html#L120">120</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      final DateFormat dateFormat = new SimpleDateFormat(INPUT_DATE_FORMAT);
      dateFormat.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));
      Date bt;
      try {
        bt = dateFormat.parse(t1);
        startTime = J2kSec.fromDate(bt);
      } catch (final ParseException e) {
        startTime = Double.NaN;
      }
    }

    return timeOrMaxDays(startTime);
  }

  /*
   * convert time back to UTC
   */
  protected Double getStartTime(final String t1, final Double endTime, final long mult,
      final TimeZone tz) {
    final double startTime = getStartTime(t1, endTime, mult);
    return timeOrMaxDays(startTime - (tz.getOffset(J2kSec.asEpoch(endTime))));
  }

  /**
   * parse end time
   * 
   * @param t2
   * @return
   */
  protected Double getEndTime(final String t2) {
    Double endTime = Double.NaN;
    if (t2 == null || t2.equalsIgnoreCase(&quot;now&quot;))
      endTime = J2kSec.now();
    else {
      final DateFormat dateFormat = new SimpleDateFormat(INPUT_DATE_FORMAT);</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L564">564</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/db/InputEW.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/InputEW.html#L556">556</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>          checkTableCache.remove(table);

          winston.getStatement().execute(&quot;DROP TABLE `&quot; + table + &quot;`&quot;);
          winston.getStatement().execute(&quot;DROP TABLE `&quot; + ss[0] + &quot;$$H&quot; + ss[1] + &quot;`&quot;);
          deleted = true;
          LOGGER.info(&quot;Deleted table: {}&quot;, table);
        } catch (final Exception e) {
          LOGGER.error(&quot;Could not drop old table: {}.  Are permissions set properly?&quot;, channel);
        }
      } else {
        if (deleted) {
          try {
            final String nextLowestTable = table;
            final ResultSet rs = winston.getStatement()
                .executeQuery(&quot;SELECT MIN(st) FROM `&quot; + nextLowestTable + &quot;`&quot;);
            rs.next();
            final double t1 = rs.getDouble(1);
            setTimeSpan(channel, t1, Double.NaN);
            rs.close();
            setTime = true;
          } catch (final Exception e) {
            LOGGER.error(&quot;Could not update span after dropping table: &quot;, channel);</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/server/http/cmd/HeliCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/HeliCommand.html#L81">81</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/RsamCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/RsamCommand.html#L236">236</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      png = settings.createPlot(heliData).getPNGBytes();
    } catch (PlotException e) {
      throw new UtilException(e.getLocalizedMessage());
    }

    FullHttpResponse response = new DefaultFullHttpResponse(request.getProtocolVersion(),
        HttpResponseStatus.OK, Unpooled.copiedBuffer(png));
    response.headers().set(HttpHeaders.Names.CONTENT_LENGTH, png.length);
    response.headers().set(HttpHeaders.Names.CONTENT_TYPE, &quot;image/png&quot;);

    int httpRefreshInterval = configFile.getInt(&quot;wws.httpRefreshInterval&quot;, -1);
    if (httpRefreshInterval &gt; 0)
      response.headers().set(&quot;Refresh&quot;, httpRefreshInterval + &quot;; url=&quot; + request.getUri());

    if (HttpHeaders.isKeepAlive(request)) {
      response.headers().set(HttpHeaders.Names.CONNECTION, HttpHeaders.Values.KEEP_ALIVE);
    }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpGapsCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/HttpGapsCommand.html#L261">261</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/cmd/GapsCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/cmd/GapsCommand.html#L219">219</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>  void writeComputer() {

    final StringBuilder header = new StringBuilder();
    final StringBuilder output = new StringBuilder();
    output.append(&quot;# Gap Start\t\tGap End\t\t\tDuration\n&quot;);

    // Write Computer Data Gaps
    gapCount = 0;
    totalGapLength = 0;

    for (final double[] gap : gaps) {
      gapLength = gap[1] - gap[0];
      if (gapLength &lt; minGapDuration) {
        continue;
      } else {
        output.append(gap[0] + &quot;\t&quot; + gap[1] + &quot;\t&quot; + gapLength + &quot;\n&quot;);
        gapCount++;
        totalGapLength = totalGapLength + gapLength;
      }
    }

    // Write Computer Winston Gaps
    header.append(&quot;# Start Time: &quot; + startTimeS + &quot; (&quot; + startTime + &quot;)\n# End Time: &quot; + endTimeE
        + &quot; (&quot; + endTime + &quot;)\n# Total Time: &quot; + totalTime + &quot;\n# Time Zone: &quot; + timeZone
        + &quot;\n# Station: &quot; + code + &quot;\n# Minumum Gap Duration: &quot; + minGapDuration + &quot;\n# GapCount: &quot;
        + gapCount + &quot;\n&quot;);</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetMetadataCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetMetadataCommand.html#L102">102</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/wws/cmd/GetMetadataCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/wws/cmd/GetMetadataCommand.html#L120">120</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      sb.append(timeOrMaxDays(ch.getMaxTime()));
      sb.append(&quot;,&quot;);
      sb.append(&quot;alias=&quot;);
      sb.append(escape(ch.getAlias()));
      sb.append(&quot;,&quot;);
      sb.append(&quot;unit=&quot;);
      sb.append(escape(ch.getUnit()));
      sb.append(&quot;,&quot;);
      sb.append(&quot;linearA=&quot;);
      sb.append(ch.getLinearA());
      sb.append(&quot;,&quot;);
      sb.append(&quot;linearB=&quot;);
      sb.append(ch.getLinearB());
      sb.append(&quot;,&quot;);
      appendList(sb, &quot;groups&quot;, ch.getGroups());
      sb.append(&quot;,&quot;);
      appendMap(sb, ch.getMetadata());
      sb.append(&quot;\n&quot;);
    }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/http/AbstractHttpCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/http/AbstractHttpCommand.html#L179">179</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/server/http/HttpBaseCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/server/http/HttpBaseCommand.html#L154">154</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>      final DateFormat dateFormat = new SimpleDateFormat(INPUT_DATE_FORMAT);
      dateFormat.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));
      Date bt;
      try {
        bt = dateFormat.parse(t2);
        endTime = J2kSec.fromDate(bt) - 1;
      } catch (final ParseException e) {
        endTime = Double.NaN;
      }
    }

    return timeOrMaxDays(endTime);
  }

  /**
   * convert back to UTC
   * 
   */
  protected Double getEndTime(final String t2, final TimeZone tz) {
    final Double endTime = getEndTime(t2);
    return timeOrMaxDays(endTime - (tz.getOffset(J2kSec.asEpoch(endTime))));
  }

  /**
   * Apply maxDays to time
   * 
   * @param t
   *          time
   * @return greater of t or now less maxDays
   */
  protected double timeOrMaxDays(final double t) {
    if (maxDays == 0)
      return t;
    else
      return Math.max(t, J2kSec.now() - (maxDays * ONE_DAY));</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNCommand.html#L40">40</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNLCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNLCommand.html#L44">44</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    double t2 = Time.ewToj2k(cmd.getT2(false));
    t2 = timeOrMaxDays(t2);

    final double[] bounds = checkTimes(sid, t1, t2);
    if (!allowTransaction(bounds)) {
      netTools.writeString(cmd.getEarthwormErrorString(sid, getError(bounds)), channel);
      return;
    }
    Wave wave = null;
    try {
      wave = data.getWave(sid, t1, t2, 0);
    } catch (final UtilException e) {
    }
    if (wave != null)
      totalBytes = writeWaveAsAscii(wave, sid, cmd.getID(), cmd.getS(), cmd.getC(), cmd.getN(),</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/tools/pannel/ExportSACPanel.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/tools/pannel/ExportSACPanel.html#L184">184</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/tools/pannel/ImportWSPanel.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/tools/pannel/ImportWSPanel.html#L247">247</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    }
  }

  public class TimeRangeDocumentListener implements DocumentListener {

    JTextField f;

    public TimeRangeDocumentListener(final JTextField f) {
      this.f = f;
    }

    public void insertUpdate(final DocumentEvent e) {
      f.setBackground(validateTime() ? Color.white : RED);
    }

    public void removeUpdate(final DocumentEvent e) {
      f.setBackground(validateTime() ? Color.white : RED);
    }

    public void changedUpdate(final DocumentEvent e) {}

    private boolean validateTime() {
      try {
        Time.parseTimeRange(f.getText());
        return true;
      } catch (final ParseException ex) {
        return false;
      }
    }
  }
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNLRawCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNLRawCommand.html#L77">77</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNRawCommand.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/cmd/GetSCNRawCommand.html#L68">68</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>          channel);

    int totalBytes = 0;
    if (result != null) {
      final String hdr = id + &quot; &quot; + (String) result[0] + &quot;\n&quot;;
      final int bytes = ((Integer) result[1]).intValue();
      final List&lt;?&gt; items = (List&lt;?&gt;) result[2];
      final ByteBuffer bb = ByteBuffer.allocate(bytes);
      for (final Iterator&lt;?&gt; it = items.iterator(); it.hasNext();) {
        bb.put((byte[]) it.next());
      }
      bb.flip();</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/WWSClient.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/WWSClient.html#L285">285</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/legacyServer/WWSClient.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/WWSClient.html#L356">356</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    Wave wave = winston.getWave(sta, comp, net, loc, st, et, false);

    if (wave != null) {
      wave = wave.subset(st, et);

      final SeismicDataFile file = SeismicDataFile.getFile(fn, FileType.SAC);
      String channel = sta + &quot;_&quot; + comp + &quot;_&quot; + net;
      if (loc != null)
        channel += &quot;_&quot; + loc;

      file.putWave(channel, wave);
      try {
        file.write();
      } catch (final IOException e) {
        System.err.println(&quot;Couldn't write file: &quot; + e.getLocalizedMessage());
        e.printStackTrace();
      }
    } else {
      System.out.println(&quot;Wave not found&quot;);
    }
  }

  public static void outputSac(final String server, final int port, final Double st,</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/legacyServer/WWSClient.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/WWSClient.html#L276">276</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/legacyServer/WWSClient.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/legacyServer/WWSClient.html#L381">381</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    final WWSClient winston = new WWSClient(s, p);
    winston.connect();

    final String[] chan = c.split(&quot;\\$&quot;);
    final String sta = chan[0];
    final String comp = chan[1];
    final String net = chan[2];
    final String loc = chan.length == 4 ? chan[3] : null;

    Wave wave = winston.getWave(sta, comp, net, loc, st, et, false);

    if (wave != null) {
      wave = wave.subset(st, et);</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L271">271</a></td></tr>
<tr class="a">
<td>gov/usgs/volcanoes/winston/db/Input.java</td>
<td><a href="./xref/gov/usgs/volcanoes/winston/db/Input.html#L398">398</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    try {
      final String code = tb.toWinstonString();
      ChannelInputOptimizer opt = channelOptimizers.get(code);
      if (opt == null) {
        opt = new ChannelInputOptimizer(code);
        channelOptimizers.put(code, opt);
        final double[] span = data.getTimeSpan(code);
        opt.t1 = span[0];
        opt.t2 = span[1];
      }

      winston.useDatabase(code);
      final double ts = tb.getStartTimeJ2K();
      final String date = dateFormat.format(J2kSec.asDate(ts));</pre></div></td></tr></table></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2016.
          All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
